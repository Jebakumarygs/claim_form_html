<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Submission</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <header>
        <h1>Submit Your Claim</h1>
    </header>

    <div class="container">
        <form id="claimForm" enctype="multipart/form-data">
                <h2>Contact Information</h2>

            <label>First Name</label>
            <input name="first_name" placeholder="First name (e.g. Jane)" value="Andrew" />

            <label>Last Name</label>
            <input name="last_name" placeholder="Last name (e.g. Doe)" value="Wilkins" />

            <label>Email</label>
            <input name="email" placeholder="Email (e.g. jane.doe@example.com)" value="andrew.wilkins@dechert.com" />

            <h2>Company Details</h2>

            <label>Company Name</label>
            <input name="company_name" placeholder="Company name (e.g. Acme Corp)" value="Dechert, LLP" />

            <label>Company Address</label>
            <input name="company_address" placeholder="Address (e.g. 123 Main St)" value="123 Main St" />

            <label>Company City</label>
            <input name="company_city" placeholder="City (e.g. Anytown)" value="Anytown" />

            <label>Company State</label>
            <input name="company_state" placeholder="State (e.g. CA)" value="CA" />

            <label>Company ZIP</label>
            <input name="company_zip" placeholder="ZIP (e.g. 12345)" value="12345" />

            <h2>Claim Information</h2>

            <label>Claim Amount</label>
            <input name="claim_amount" placeholder="Claim amount (e.g. 1000)" value="28895.00" />

            <label>Basis of Claim</label>
            <input name="basis_of_claim" placeholder="Basis of claim (e.g. Services performed)" value="Services performed" />

            <label>Claim Type</label>
            <input name="claim_type" placeholder="Claim type (e.g. Monetary)" value="Monetary" />

            <label>Description</label>
            <textarea name="claim_description" placeholder="Describe the claim briefly"></textarea>

            <h2>Supporting Documents</h2>

            <label class="upload-label">Upload Supporting Documents</label>

            <div class="upload-box" id="uploadBox">
                <div class="upload-actions">
                    <button type="button" id="pickerUpload" class="btn">Upload from computer</button>
                    <button type="button" id="pickerChoose" class="btn">Select Sample Files</button>
                </div>
                <input type="file" name="supporting_documents" id="supporting_documents" multiple />
            </div>

            <ul id="fileList"></ul>

            <button type="submit" class="submit-btn">Submit</button>
        </form>
    </div>

    <footer>
        <p>&copy; 2024 Claim Portal</p>
    </footer>

    <!-- Modal Popup for Processing & Response -->
    <div id="modalOverlay" class="modal-overlay hidden" tabindex="-1">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-body">
                <div class="modal-header">
                    <div id="modalIcon" class="modal-icon"><div id="modalSpinner" class="spinner"></div></div>
                    <h3 id="modalTitle" class="modal-title">Processing...</h3>
                </div>
                <pre id="modalMessage" class="modal-message">Please wait while we validate your claim.</pre>
                <!-- Collapsible full JSON view (hidden by default) -->
                <pre id="modalFullJson" class="modal-fulljson" aria-hidden="true" style="display:none"></pre>

                <div class="modal-actions">
                    <button type="button" id="modalClose" class="btn close">Close</button>
                    <button type="button" id="modalCopy" class="btn">Copy</button>
                    <button type="button" id="modalToggleJson" class="btn">Open JSON</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener("load", () => {
        fetch("https://claims-validation.onrender.com/", { method: "GET" })
            .then(() => console.log("Render backend waking up…"))
            .catch(err => console.error("Wake-up failed:", err));
        });
        // Utility: show/hide modal and set content/state
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalSpinner = document.getElementById('modalSpinner');
        const modalIcon = document.getElementById('modalIcon');
        const modalClose = document.getElementById('modalClose');
        const modalCopy = document.getElementById('modalCopy');
        const modalToggleJson = document.getElementById('modalToggleJson');
        const modalFullJson = document.getElementById('modalFullJson');
        const submitBtn = document.querySelector('.submit-btn');

        function showModal({ title = 'Processing...', message = 'Please wait', state = 'processing', fullJson = null } = {}) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalOverlay.classList.remove('hidden');

            // Reset states
            modalOverlay.classList.remove('modal-success', 'modal-error');

            // Reset JSON panel
            if (modalFullJson) {
                if (fullJson) {
                    try {
                        modalFullJson.textContent = typeof fullJson === 'string' ? fullJson : JSON.stringify(fullJson, null, 2);
                    } catch (e) {
                        modalFullJson.textContent = String(fullJson);
                    }
                    // keep element in DOM and collapsed (max-height:0) so CSS transition works
                    modalFullJson.style.display = 'block';
                    modalFullJson.classList.remove('open');
                    modalFullJson.setAttribute('aria-hidden', 'true');
                    if (modalToggleJson) modalToggleJson.style.display = 'inline-block';
                    if (modalToggleJson) modalToggleJson.textContent = 'Open JSON';
                } else {
                    modalFullJson.textContent = '';
                    modalFullJson.style.display = 'none';
                    modalFullJson.classList.remove('open');
                    if (modalToggleJson) modalToggleJson.style.display = 'none';
                }
            }

            if (state === 'processing') {
                modalSpinner.style.display = 'block';
                modalIcon.style.display = 'flex';
                modalOverlay.classList.remove('modal-success', 'modal-error');
            } else {
                modalSpinner.style.display = 'none';
                modalIcon.style.display = 'flex';
                modalOverlay.classList.add(state === 'success' ? 'modal-success' : 'modal-error');
            }
        }

        function hideModal() {
            modalOverlay.classList.add('hidden');
        }

        modalClose.addEventListener('click', () => {
            hideModal();
        });

        // Copy modal text
        modalCopy.addEventListener('click', () => {
            try {
                const toCopy = (modalFullJson && modalFullJson.classList.contains('open')) ? modalFullJson.textContent : (modalMessage.textContent || '');
                navigator.clipboard.writeText(toCopy || '');
            } catch (e) {
                console.warn('Copy failed', e);
            }
        });

        // Modal must be closed manually via the Close button.
        // Ignore outside clicks and Escape key so users can't dismiss it accidentally.
        // (Close is handled by `modalClose` click listener defined above.)

        // Toggle full JSON accordion (class-based open/close)
        modalToggleJson.addEventListener('click', () => {
            if (!modalFullJson) return;
            const willOpen = !modalFullJson.classList.contains('open');
            if (willOpen) {
                modalFullJson.classList.add('open');
                modalFullJson.setAttribute('aria-hidden', 'false');
                modalToggleJson.textContent = 'Close JSON';
            } else {
                modalFullJson.classList.remove('open');
                modalFullJson.setAttribute('aria-hidden', 'true');
                modalToggleJson.textContent = 'Open JSON';
            }
        });

        // Upload/select buttons behavior
        const pickerUpload = document.getElementById('pickerUpload');
        const pickerChoose = document.getElementById('pickerChoose');
        const fileInput = document.getElementById('supporting_documents');
        const fileListEl = document.getElementById('fileList');

        let selectedSampleFiles = []; // Array<File> reconstructed from sample docs

        // Primary buttons: upload and select sample files
        pickerUpload.addEventListener('click', () => fileInput.click());
        pickerChoose.addEventListener('click', () => openSavedFilesModal());

        // Helper to render combined file list (local input files + selected saved files)
        function renderFileList() {
            fileListEl.innerHTML = '';
            const localFiles = Array.from(fileInput.files || []);

            localFiles.forEach((file, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${file.name}</span> (${Math.round(file.size / 1024)} KB) <small class="tag">local</small> <button type="button" data-local-idx="${idx}" class="remove-local">Remove</button>`;
                fileListEl.appendChild(li);
            });

            selectedSampleFiles.forEach((file, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${file.name}</span> (${Math.round(file.size / 1024)} KB) <small class="tag">sample</small> <button type="button" data-sample-idx="${idx}" class="remove-sample">Remove</button>`;
                fileListEl.appendChild(li);
            });

            // Remove button for sample files
            Array.from(document.querySelectorAll('.remove-sample')).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = Number(e.target.getAttribute('data-sample-idx'));
                    selectedSampleFiles.splice(idx, 1);
                    renderFileList();
                });
            });

            // Remove button for local files
            Array.from(document.querySelectorAll('.remove-local')).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = Number(e.target.getAttribute('data-local-idx'));
                    removeLocalFile(idx);
                });
            });
        }

        // Show Selected Files and save to localStorage
        fileInput.addEventListener('change', async function () {
            renderFileList();
            // No persistent saved files — just render list
            renderFileList();
        });

        // Remove a local file by index by rebuilding the FileList
        function removeLocalFile(removeIdx) {
            const current = Array.from(fileInput.files || []);
            const dt = new DataTransfer();
            current.forEach((f, i) => {
                if (i !== removeIdx) dt.items.add(f);
            });
            fileInput.files = dt.files;
            renderFileList();
        }

        // no localStorage persistence for files

        // Open modal listing sample documents
        async function openSavedFilesModal() {
            // Hardcoded sample file names (works in GitHub and local environments)
            const sampleFiles = [
                { name: '133282572_1166778581_154552217_90207391.pdf', path: 'sample_docs/133282572_1166778581_154552217_90207391.pdf' },
                { name: '133282572_1222983294_154552217_LinkPOCBackup.pdf', path: 'sample_docs/133282572_1222983294_154552217_LinkPOCBackup.pdf' },
                { name: 'valid_invoice1.pdf', path: 'sample_docs/valid_invoice1.pdf' },
                { name: 'valid_invoice2.pdf', path: 'sample_docs/valid_invoice2.pdf' },
                { name: 'valid_invoice3.pdf', path: 'sample_docs/valid_invoice3.pdf' },
                { name: 'valid_invoice4.pdf', path: 'sample_docs/valid_invoice4.pdf' }
            ];

            // Build modal (samples-only)
            const pickerHtml = document.createElement('div');
            pickerHtml.className = 'saved-files-modal';
            pickerHtml.innerHTML = `
                <div class="saved-files-body">
                    <div class="modal-tabs">
                        <button type="button" class="tab-btn active" data-tab="samples">Sample Documents</button>
                    </div>
                    <div id="samplesTab" class="tab-content active">
                        <h3>Choose sample documents</h3>
                        <div class="sample-list"></div>
                    </div>
                    <div class="saved-actions">
                        <button type="button" class="btn add-selected">Add Selected</button>
                        <button type="button" class="btn close-saved">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(pickerHtml);

            // Populate sample list
            const sampleListEl = pickerHtml.querySelector('.sample-list');
            if (sampleFiles.length === 0) {
                sampleListEl.innerHTML = '<p style="color: #999; padding: 10px;">No sample documents available.</p>';
            } else {
                sampleFiles.forEach((f, i) => {
                    const item = document.createElement('div');
                    item.className = 'saved-file-item';
                    item.innerHTML = `
                        <label>
                            <input type="checkbox" data-type="sample" data-idx="${i}" data-path="${f.path}">
                            <strong title="${f.name}">${f.name}</strong>
                        </label>
                        <div class="saved-file-meta">
                            <a class="sample-link" href="${f.path}" target="_blank" rel="noopener">Open / Download</a>
                        </div>
                    `;
                    sampleListEl.appendChild(item);
                });
            }

            // Handlers
            pickerHtml.querySelector('.close-saved').addEventListener('click', () => pickerHtml.remove());

            pickerHtml.querySelector('.add-selected').addEventListener('click', async () => {
                const sampleChecked = Array.from(pickerHtml.querySelectorAll('input[data-type="sample"]:checked'));

                for (const cb of sampleChecked) {
                    const path = cb.getAttribute('data-path');
                    const name = cb.closest('label').querySelector('strong').textContent;
                    try {
                        const res = await fetch(path);
                        const blob = await res.blob();
                        const file = new File([blob], name, { type: blob.type });
                        selectedSampleFiles.push(file);
                    } catch (err) {
                        console.error('Failed to fetch sample file', err);
                    }
                }

                renderFileList();
                pickerHtml.remove();
            });
        }

        // Form Submit — include both local and selected saved files
        document.getElementById("claimForm").onsubmit = async (e) => {
            e.preventDefault();

            const localFiles = Array.from(fileInput.files || []);
            const allFiles = [...localFiles, ...selectedSampleFiles];
            if (allFiles.length === 0) {
                showModal({ title: 'No files', message: 'Please select at least one file to upload.', state: 'error' });
                return;
            }

            const formData = new FormData();
            allFiles.forEach((file) => formData.append('files', file));

            const claimAmount = document.querySelector('input[name="claim_amount"]').value;
            const companyName = document.querySelector('input[name="company_name"]').value;

            if (claimAmount) formData.append("claim_amount", claimAmount);
            if (companyName) formData.append("company_name", companyName);

            // Show processing modal
            submitBtn.disabled = true;
            submitBtn.classList.add('disabled');
            showModal({ title: 'Processing Claim', message: 'Uploading files and validating. This may take a moment...', state: 'processing' });

            try {
                const res = await fetch("https://claims-validation.onrender.com/review_claim_file", {
                    method: "POST",
                    body: formData
                });

                const result = await res.json().catch(() => ({}));

                if (res.ok) {
                    let msg = '';
                    if (result.summary) msg += `Summary:\n${result.summary}\n\n`;

                    if (result.step_results && Array.isArray(result.step_results)) {
                        msg += 'Validation Steps:\n';
                        result.step_results.forEach(step => {
                            msg += `- ${step.step_name}: ${step.status} (${step.message})\n`;
                        });
                    } else if (result.detail) {
                        msg += result.detail;
                    } else {
                        msg += 'Claim processed successfully.';
                    }

                    showModal({ title: 'Success', message: msg, state: 'success', fullJson: result });
                } else {
                    const detail = result.detail || result.message || 'Submission failed';
                    showModal({ title: 'Error', message: detail, state: 'error', fullJson: result });
                }
            } catch (error) {
                console.error('Submission error:', error);
                showModal({ title: 'Network Error', message: 'Failed to submit claim. Please try again later.', state: 'error', fullJson: null });
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('disabled');
            }
        };

    </script>

</body>

</html>